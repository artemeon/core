
# Reference: Annotations

The AGP uses annotations in various places. Annotations are used to create i.e. an OR-mapping
(object to database) or to setup the edit-form for a given object. Below is a reference of annotations
currently available.

## Model (`Kajona\System\System\Root`)

Annotation         |Context    |Introduced in     |Description
-------------------|-----------|------------------|--------------------
|@addSearchIndex	|Property	|4.4	|Marks a property as relevant for being index. As soon as the search-index of an object is updated, all properties marked with this annotation will be added to the index.
|@lifeCycleService [service]	|Class	|6.2	|A name of a service which is used to handle models. This provides an additional layer to contain business logic like i.e. sending a message if a record has changed.
|@module name	|Class	|4.3	|The name of the module the current class belongs to, e.g. "news".
|@moduleId id	|Class	|4.3	|The id-constant of the module the current class belongs to, e.g. _ navigations_module_id_
|@objectValidator class	|Class	|4.6	|Name of a class implementing ObjectValidatorInterface. Used by the form-generator to validate a classes instance during edit-operations.
|@permissionHandler [service]	|Class |7.0|Name of a service which is used to set rights on an object
|@serializable  | Property	|5.1| Indicates whether a property can be serialized through the \Kajona\System\Admin\AdminModelserializer class
|@sortManager class	|Class	|5.0| Name of the sort-manager to be used by the current model-class, instance of SortmanagerInterface
|@versionable	|Property	|4.1	|If the changlog is enabled, the old and new values are added to the changelog on object updates.

### Form

Annotation         |Context    |Introduced in     |Description
-------------------|-----------|------------------|--------------------
|@fieldDDValues key -> value	|Property	|4.3|	Only to be used in combination with '@fieldType Kajona\System\Admin\Formentries\FormentryDropdown', lists the key-value-pairs of options. Syntax: [ index => langKey ],[ index => langKey]. Example: @fieldDDValues [0 => commons_no],[1 => commons_yes]
|@fieldHidden	|Property	|4.3	|Flag to move a form-entry to the list of hidden form-fields. Hidden in terms of not visible by default, may be shown using a css / js call.
|@fieldTemplateDir path	|Property	|4.3	|Only to be used in combination with '@fieldType Kajona\Pages\Admin\Formentries\FormentryTemplate' (template formentry). Defines the path to the directory of templates to choose from.
|@fieldType class	|Property	|4.0	|Sets the formentry-renderer to be used for the property when rendering the edit-form of the current object.
|@fieldMandatory	|Property	|4.0	|Marks the property as mandatory when editing the object via the form-generator.
|@fieldLabel label	|Property	|4.0	|If given, the passed lang-key is used to label the property on object-edits using the form-generator.
|@fieldValidator validator	|Property	|4.0 |Sets the formentry-validator to be used for the property when validating the edit-form of the current object.
|@fieldHidden	|Property	|4.4	|Moves the property to the list of hidden/optinal form-elements. Hidden form-elements are not visisible by default but may be shown using a link.
|@fieldReadonly	|Property	|4.4	|Marks the property as a read-only formentry (same as setBitReadOnly(true))
|@formGenerator |Class	|4.8	|If a model defines such an annotation the getAdminForm method will return the specified formgenerator class. This is useful to build custom forms.

### ORM

Annotation         |Context    |Introduced in     |Description
-------------------|-----------|------------------|--------------------
|@blockEscaping	|Property	|4.0	|If given, the OR-mapper skips the escaping of special chars for the value of the property right before passing the value to the database.
|@blockFromAutosave	|Class	|4.6	|If a class is marked with this annotation, the generalModel unit-tests skips this class. This means, the test won't try to save and delete the object automatically. May be useful if the marked class only works in combination with other classes or hierarchy elements.
|@listOrder ASC&#124;DESC	|Property	|4.2	|The property is used as a sort-criteria when loading object-lists dynamically.
|@tableColumn table.column	|Property	|4.0	|Sets the target-column of a property, used by the OR-mapper on loading / persisting the object.
|@tableColumnDatatype type	|Property	|4.6|	Relevant when generating the CREATE TABLE ddl, sets the columns target type. See [DbDatatypes.php](https://github.com/kajona/kajonacms/blob/master/module_system/system/DbDatatypes.php) for a reference of values.
|@tableColumnIndex	|Property	|4.6|	An index is created on table-level for the given property (and so the mapped column).
|@tableColumnPrimaryKey	|Property	|4.6	|If given at a property, the ddl generated by the system will use the property as a primary key of the table.
|@targetTable table.column	|Class	|4.0|	Defines the / a target-table of the or-mapper. Syntax table.primary--id-column.

## Controller (`Kajona\System\Admin\AdminEvensimpler`)

Annotation         |Context    |Introduced in     |Description
-------------------|-----------|------------------|--------------------
|@autoTestable	|Method	|4.0	|Methods marked with this annoations are called in a unit-test during builds.
|@autoTestable actions	|Class	|4.2|	Comma-separated list of action-commands to be called in a unit-test during builds.
|@inject |Property	|5.0	|Injects the provided service name into the property. Works only inside controller or workflow classes.
|@objectList tablename (source="column", target="column", type={"class1", "class2"}, load_deleted="false")	|Property	|5.0|	Used by the OR mapper and the schemagenerator. Used to handle 1:n relations, so assignments of object. Provided are the name of the 1:n relation table. the name of the source id column and the name of the target id column. <br/><br/>Use "type" param to restrict which object types can be assigned. <br/><br/>Use load_deleted= "true" if also deleted assigned objects should be displayed
|@objectList[Name] class	|Class	|4.2|	Assigns an object type (class) to an action-name (actionList), see evensimpler-classes. Used to render a list.
|@objectEdit[Name] class	|Class	|4.2	|Assigns an object type (class) to an action-name (actionEdit), see evensimpler-classes. Used to render an edit-form.
|@objectNew[Name] class	|Class	|4.2	|Assigns an object type (class) to an action-name (actionNew), see evensimpler-classes. Used to render a new-instance form.
|@objectFilter[Name] class	|Class	|4.7	|Assigns an filter object (class) to for an object, see evensimpler-classes. Used to render a filter for list actions (e.g. actionList)form.
|@permissions permission	|Action-Method	|4.0|Comma-separated list of permission required to execute the action (one / many of view, edit, delete, right, right1, right2, right3, right4, right5)
|@responseType  | Action-Method	|6.2| Defines the HTTP response type, e.g. one of JSON, XML, HTML. See [HttpResponsetypes.php](https://github.com/kajona/kajonacms/blob/master/module_system/system/HttpResponsetypes.php) for a list of values.

## Filter (`Kajona\System\System\FilterBase`)

Annotation         |Context    |Introduced in     |Description
-------------------|-----------|------------------|--------------------
|@filterCompareOperator operator |Property	|5.0|	Only to be used for properties in classes which are derived from FilterBase. Possible values are: EQ, GT, LT, GE, LE, NE, LIKE 

## Command (`Kajona\System\System\Messagequeue\CommandInterface`)

Annotation         |Context    |Introduced in     |Description
-------------------|-----------|------------------|--------------------
|@executor	|Class	|7.2	|Defines a specific service which is used to execute a command

## API (`Kajona\Api\System\ApiControllerInterface`)

|Annotation        |Context    |Since |Description
|------------------|-----------|------|--------------------
|@api	           |Method	   |7.2	  |Declares that the method is accessible through the API.
|@authorization    |Method	   |7.2	  |Defines the authorization type. By default your method should use `usertoken` but it is also possible to use `anonymous` if you want that your method can be accessed without user authentication.
|@method           |Method	   |7.2	  |Defines the required HTTP method i.e. GET or POST.
|@path             |Method	   |7.2	  |Defines the route which invokes this method. More details at the [Slim Router](http://www.slimframework.com/docs/v3/objects/router.html) documentation.

### Meta

At the API layer it is possible to describe an endpoint through different annotations. These annotations
can describe the data provided in the path, query and body parameters. The following example shows 
how to describe an API action:

```php
<?php

namespace AGP\Acme\Api;

use Kajona\Api\System\ApiControllerInterface;
use Kajona\Api\System\Http\JsonResponse;

class AcmeApiController implements ApiControllerInterface
{
    /**
     * @api
     * @method POST
     * @path /v1/acme/my/{foo}
     * @authorization usertoken
     *
     * @QueryParam(name="foo", type="integer", description="Test")
     * @QueryParam(name="bar", type="string", format="date-time")
     * @QueryParam(name="bar", type="string", required=true)
     * @QueryParam(name="baz", type="string", enum={"foo", "bar"})
     * @QueryParam(name="boz", type="string", pattern="[A-z]+")
     * @PathParam(name="foo", type="string", description="Test")
     * @BodyParam(name="foo", type="string", description="Test")
     */
    public function myAction(): JsonResponse
    {
        return new JsonResponse([
            'hello' => 'world!'
        ]);
    }
}
```

The path and query param describe that data from the request [URI](https://tools.ietf.org/html/rfc3986#section-3).
Through the body param annotation we can describe a simple JSON object. I.e. if your endpoint
receives a payload like:

```
{
  "foo": "bar"
}
```

You could describe the payload with:

```
@BodyParam(name="foo", type="string")
```

The body param annotation refers always to the request body. If you have more complex nested data you
can use a JsonSchema to describe the data. Therefor you can use the incoming and outgoing annotation i.e.:

```
@Incoming(schema="../schema/request-schema.json")
@Outgoing(code=200, schema="../schema/response-schema.json")
```

The path is relative to your API controller and points to a JSONSchema file describing the JSON structure.
More information about JSONSchema at: https://json-schema.org

In the future we can generate based on those meta information an [OpenAPI](https://www.openapis.org/)
specification to describe our API. Through this other clients can easily consume our internal API and
it is also possible to automatically [generate clients](https://openapi-generator.tech/).
